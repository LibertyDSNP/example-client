"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const crypto_1 = require("crypto");
const ethers_1 = require("ethers");
const config_1 = require("../../config");
const messages_1 = require("./messages");
describe("messages", () => {
    describe("#serialize", () => {
        it("returns the correct serialization for a given message", () => __awaiter(void 0, void 0, void 0, function* () {
            const message = messages_1.createBroadcastMessage("1", "https://dsnp.org", "0x12345");
            const serializedMessage = yield messages_1.serialize(message);
            expect(serializedMessage).toEqual("contentHash0x12345dsnpType2fromId1urlhttps://dsnp.org");
        }));
    });
    describe("#sign", () => {
        beforeAll(() => __awaiter(void 0, void 0, void 0, function* () {
            const privateKey = "0x6dcefd57d921dc570e198f6bd9dffc32954ab071184c780770cf4541dd23f68e";
            yield config_1.setConfig(Object.assign(Object.assign({}, config_1.getConfig()), { signer: new ethers_1.ethers.Wallet(privateKey) }));
        }));
        it("returns a valid signature for a valid private key and message", () => __awaiter(void 0, void 0, void 0, function* () {
            const message = messages_1.createBroadcastMessage("1", "https://dsnp.org", "0x12345");
            const signedMessage = yield messages_1.sign(message);
            expect(signedMessage.signature).toEqual("0xdfd1e58a5947e98aa5aa0276e8b0c54bc3cc433ae588d1844755624e33a55cb430f221ae090ac73e890eab9d244c7eebc6b23c76a05e1353c4a7b530a322048c1b");
        }));
    });
    describe("#recoverPublicKey", () => {
        const publicKey = "0x7794b74C1173AAC399e542c74390b3981d92835A";
        it("returns the correct public key for a valid signature", () => {
            const message = messages_1.createBroadcastMessage("1", "https://dsnp.org", "0x12345");
            const signature = "0xd33f14693809e6c7bcd5148cb585a63ce51d54bd229a7306dab22d3437b001140538494c1b7b19a2a806bcc6da26fc205b237cfe4a60dd738d994ec72e2a6a561c";
            expect(messages_1.recoverPublicKey(message, signature)).toEqual(publicKey);
        });
        it("returns a different public key for an invalid signature", () => {
            const message = messages_1.createBroadcastMessage("1", "https://dsnp.org", "0x12345");
            const signature = "0x168aeea67ab8e6b60a8d004ab57e17bab16dac135bcc9d9c8b34058808befd371e5d34ee6b1dc18b3d86e63765352286ba949a39cd458138cad7895b7faca2cb1c";
            expect(messages_1.recoverPublicKey(message, signature)).not.toEqual(publicKey);
        });
    });
    it("round trip signs and verifies messages", () => __awaiter(void 0, void 0, void 0, function* () {
        const message = messages_1.createBroadcastMessage("1", "https://dsnp.org", "0x12345");
        const privateKey = `0x${Buffer.from(crypto_1.randomBytes(32)).toString("hex")}`;
        const signer = new ethers_1.ethers.Wallet(privateKey);
        const address = yield signer.getAddress();
        yield config_1.setConfig(Object.assign(Object.assign({}, config_1.getConfig()), { signer }));
        const signedMessage = yield messages_1.sign(message);
        expect(messages_1.recoverPublicKey(message, signedMessage.signature)).toEqual(address);
    }));
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVzc2FnZXMudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb3JlL21lc3NhZ2VzL21lc3NhZ2VzLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQSxtQ0FBcUM7QUFDckMsbUNBQWdDO0FBRWhDLHlDQUFvRDtBQUNwRCx5Q0FBdUY7QUFFdkYsUUFBUSxDQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUU7SUFDeEIsUUFBUSxDQUFDLFlBQVksRUFBRSxHQUFHLEVBQUU7UUFDMUIsRUFBRSxDQUFDLHVEQUF1RCxFQUFFLEdBQVMsRUFBRTtZQUNyRSxNQUFNLE9BQU8sR0FBRyxpQ0FBc0IsQ0FBQyxHQUFHLEVBQUUsa0JBQWtCLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFDM0UsTUFBTSxpQkFBaUIsR0FBRyxNQUFNLG9CQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFbkQsTUFBTSxDQUFDLGlCQUFpQixDQUFDLENBQUMsT0FBTyxDQUFDLHVEQUF1RCxDQUFDLENBQUM7UUFDN0YsQ0FBQyxDQUFBLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUU7UUFDckIsU0FBUyxDQUFDLEdBQVMsRUFBRTtZQUNuQixNQUFNLFVBQVUsR0FBRyxvRUFBb0UsQ0FBQztZQUN4RixNQUFNLGtCQUFTLGlDQUNWLGtCQUFTLEVBQUUsS0FDZCxNQUFNLEVBQUUsSUFBSSxlQUFNLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUNyQyxDQUFDO1FBQ0wsQ0FBQyxDQUFBLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQywrREFBK0QsRUFBRSxHQUFTLEVBQUU7WUFDN0UsTUFBTSxPQUFPLEdBQUcsaUNBQXNCLENBQUMsR0FBRyxFQUFFLGtCQUFrQixFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQzNFLE1BQU0sYUFBYSxHQUFHLE1BQU0sZUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBRTFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLENBQUMsT0FBTyxDQUNyQyxzSUFBc0ksQ0FDdkksQ0FBQztRQUNKLENBQUMsQ0FBQSxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxtQkFBbUIsRUFBRSxHQUFHLEVBQUU7UUFDakMsTUFBTSxTQUFTLEdBQUcsNENBQTRDLENBQUM7UUFFL0QsRUFBRSxDQUFDLHNEQUFzRCxFQUFFLEdBQUcsRUFBRTtZQUM5RCxNQUFNLE9BQU8sR0FBRyxpQ0FBc0IsQ0FBQyxHQUFHLEVBQUUsa0JBQWtCLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFDM0UsTUFBTSxTQUFTLEdBQ2Isc0lBQXNJLENBQUM7WUFFekksTUFBTSxDQUFDLDJCQUFnQixDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNsRSxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyx5REFBeUQsRUFBRSxHQUFHLEVBQUU7WUFDakUsTUFBTSxPQUFPLEdBQUcsaUNBQXNCLENBQUMsR0FBRyxFQUFFLGtCQUFrQixFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQzNFLE1BQU0sU0FBUyxHQUNiLHNJQUFzSSxDQUFDO1lBRXpJLE1BQU0sQ0FBQywyQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3RFLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxFQUFFLENBQUMsd0NBQXdDLEVBQUUsR0FBUyxFQUFFO1FBQ3RELE1BQU0sT0FBTyxHQUFHLGlDQUFzQixDQUFDLEdBQUcsRUFBRSxrQkFBa0IsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUMzRSxNQUFNLFVBQVUsR0FBRyxLQUFLLE1BQU0sQ0FBQyxJQUFJLENBQUMsb0JBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO1FBQ3ZFLE1BQU0sTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUM3QyxNQUFNLE9BQU8sR0FBRyxNQUFNLE1BQU0sQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUUxQyxNQUFNLGtCQUFTLGlDQUNWLGtCQUFTLEVBQUUsS0FDZCxNQUFNLElBQ04sQ0FBQztRQUVILE1BQU0sYUFBYSxHQUFHLE1BQU0sZUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRTFDLE1BQU0sQ0FBQywyQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzlFLENBQUMsQ0FBQSxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyJ9